<!--
SPDX-License-Identifier: BSD-3-Clause
Copyright (c) 2026 Quant Civil
-->
# Dataset Headers

Defines a compact, extensible YAML schema describing extracted datasets before sharding.

## Schema (v0)
- `dataset_id` (str): stable identifier.
- `version` (str): header format or dataset release tag.
- `description` (str): short human-readable note.
- `source_root` (str): root under `training/datasets/extracted` (relative or absolute).
- `modalities` (list): one entry per modality.
  - `name` (str), `role` (`input`|`target`), `kind` (`raster`), `pattern` (glob; `{split}` placeholder allowed).
  - Optional: `channels` (int), `dtype` (str), `nodata` (num), `georef_required` (bool), `label_values` (list[int]).
  - Inputs must be 3-band RGB; headers with other channel counts are rejected, and shard loading enforces the same.
- `pairing`: how to align modalities.
  - `strategy`: `by_stem` (v0) pairs on filename stem.
  - `input_modality` (str), `target_modality` (str|null).
  - `has_target_maps` (bool) must match reality: set `true` when a target modality exists, otherwise validation fails (and vice versa).
- `splits`:
  - `raw` (list[str]): raw split folders to scan.
  - `seed` (int): RNG seed for deterministic split assignment.
  - `labeled_policy`: `validation_only_with_metrics_subset` (v0) routes labeled items to val/metrics_train.
  - `train_metric_fraction_of_labeled` (float): portion of labeled items sent to `metrics_train` (rest -> `val`).
  - `ratios` (map[str,float], optional): proportion of the full dataset assigned to each split (e.g., train/val/test). Ratios are normalized; rounding is deterministic via `seed`.
  - `manifest_files` (map[str,str], optional): explicit manifest paths per split (e.g., `train.txt`); bypasses ratio logic.
  - `preserve_raw_split` (bool, optional): keep items in their raw split buckets without re-assigning (useful for datasets with fixed train/test like Inria).
- `sharding`:
  - `shard_size` (int): max items per shard directory.
  - `layout_version` (int): shard format version tag.
  - `copy_mode` (`copy`): physical copy semantics (no symlinks in v0).
  - `force_uncompressed_tiff` (bool): rewrite outputs to uncompressed GeoTIFF.
- `validation_metrics`:
  - `iou_ignore_label_leq` (int): labels ≤ threshold ignored for IoU.
  - `iou_average` (str): aggregation rule (`macro_over_present_labels`).

## Example (ms_buildings)
```
# SPDX-License-Identifier: BSD-3-Clause
# Generated by training/datasets/generate_headers.py
dataset_id: ms_buildings
version: "0.1.0"
description: Microsoft building footprints tiles (Massachusetts); sat imagery paired with binary building masks.
source_root: ms_buildings
modalities:
  - name: sat
    role: input
    kind: raster
    pattern: "{split}/sat/*.tiff"
    channels: 3
    dtype: uint8
  - name: map
    role: target
    kind: raster
    pattern: "{split}/map/*.tif"
    channels: 3
    dtype: uint8
    label_values: [0, 255]
pairing:
  strategy: by_stem
  input_modality: sat
  target_modality: map
splits:
  raw: [training, val, test]
  seed: 123
  labeled_policy: validation_only_with_metrics_subset
  train_metric_fraction_of_labeled: 0.25
  ratios:
    train: 0.6
    val: 0.3
    test: 0.1
sharding:
  shard_size: 512
  layout_version: 1
  copy_mode: copy
  force_uncompressed_tiff: true
validation_metrics:
  iou_ignore_label_leq: 0
  iou_average: macro_over_present_labels
```

## Workflow
1. Generate header(s):
  - All datasets discovered under `training/datasets/extracted`: `python -m training.datasets.generate_headers --dry-run` (inspect) then rerun without `--dry-run` to write YAMLs.
  - Single dataset: `python -m training.datasets.generate_headers --dataset ms_buildings` (or `whu_building`).
  Defaults expect `training/datasets/extracted`; tools fall back to `training/datasets/data/extracted` if the top-level path is absent.
2. Build shards:
    - All headers: `python -m training.datasets.build_shards --overwrite --seed 123 --shard-size 512 --threads 4` (clears `processed` first unless `--dry-run`; `--threads` defaults to 4).
  - Single dataset: add `--dataset-id ms_buildings`.
3. Outputs land in `training/datasets/processed/{split}/{dataset_id}/shard-xxxxx/` with uncompressed `.tif` tiles and `index.jsonl`; summaries live in `training/datasets/processed/metadata/*_summary.json`.

## Superpixel precompute (deterministic, scale-invariant)
- Superpixels are computed during sharding (never at training time) with OpenCV SLICO in Lab space and an edge-density heuristic that scales with patch size.
- Region size is chosen per patch via `edge_density` (Sobel p90 on the L channel) and clamped to `[min_size, max_size]` (defaults 8–64 for 512px patches, scaled by patch size). Defaults: factors `[0.75, 1.0, 1.35]` for fine/medium/coarse.
- Stored per patch in `slic/*.npz`:
  - `labels` (medium), `labels_fine`, `labels_coarse`, plus boundary masks `edges*`; optional `labels_seeds`/`edges_seeds` if SEEDS is available.
  - `slic_meta` in `index.jsonl` records edge stats, chosen sizes, algorithm, iterations, whether SEEDS ran, and whether a fallback was used.
- Previews (`--viz-interval`) now show RGB, mean-color-per-superpixel, random seeded colors, and boundary overlays (fine=green, medium=red, coarse=blue). Previews are skipped if a fallback (grid) SLIC is used.
- If `cv2.ximgproc` is unavailable, the builder writes a deterministic grid-based fallback (records `fallback_used=true`, `fallback_reason`) so training can proceed. Real SLIC is still preferred when OpenCV contrib is installed.

## Training loader requirements
- Shard indices must carry `slic` entries by default; `DataConfig.require_slic=True` raises if a shard is missing SLIC. Set `require_slic=false` only for legacy shards (they load zero-valued superpixel maps and skip boundary priors).

Supported generators:
- `ms_buildings` — paired sat/map tiles with ratios 0.6/0.3/0.1.
- `whu_building` — imagery-only tiles (no bundled masks) with ratios 0.6/0.3/0.1.
- `openearth` — multi-city imagery + labels split via `train.txt`/`val.txt`/`test.txt` manifests at the dataset root.
- `inria` — aerial building imagery under `{split}/images/*.tif` with masks under `{split}/gt/*.tif`; honors raw `train`/`test` splits (`preserve_raw_split: true`).
